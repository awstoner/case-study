2024-05-28 19:15:47,102 - MainThread - sqlmesh.core.config.connection - INFO - Creating new DuckDB adapter for data files: {'db.db'} (connection.py:294)
2024-05-28 19:15:47,453 - MainThread - sqlmesh.core.config.connection - INFO - Using existing DuckDB adapter due to overlapping data file: db.db (connection.py:290)
2024-05-28 19:15:52,480 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Listing data objects in schema db.sqlmesh__splice_case_study (evaluator.py:266)
2024-05-28 19:15:52,481 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: SELECT CURRENT_CATALOG() (base.py:1834)
2024-05-28 19:15:52,483 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: SELECT CURRENT_CATALOG() (base.py:1834)
2024-05-28 19:15:52,485 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: SELECT table_name AS name, table_schema AS schema, CASE table_type WHEN 'BASE TABLE' THEN 'table' WHEN 'VIEW' THEN 'view' WHEN 'LOCAL TEMPORARY' THEN 'table' END AS type FROM information_schema.tables WHERE table_schema = 'sqlmesh__splice_case_study' AND table_name IN ('splice_case_study__seed_model__84995534', 'splice_case_study__view_model__3877885668__temp', 'splice_case_study__view_model__3877885668', 'splice_case_study__incremental_model__4290955', 'splice_case_study__incremental_model__4290955__temp', 'splice_case_study__seed_model__84995534__temp') (base.py:1834)
2024-05-28 19:15:52,516 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Creating schema 'db.sqlmesh__splice_case_study' (evaluator.py:850)
2024-05-28 19:15:52,516 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE SCHEMA IF NOT EXISTS "db"."sqlmesh__splice_case_study" (base.py:1834)
2024-05-28 19:15:52,517 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Creating view 'db.sqlmesh__splice_case_study.splice_case_study__view_model__3877885668__temp' (evaluator.py:1587)
2024-05-28 19:15:52,543 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE OR REPLACE VIEW "db"."sqlmesh__splice_case_study"."splice_case_study__view_model__3877885668__temp" AS WITH "total_customers_by_month" AS (SELECT COUNT(DISTINCT "incremental_model"."user_id") AS "customer_count", "incremental_model"."month" AS "month" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__4290955__temp" AS "incremental_model" WHERE "incremental_model"."customer_flag" = 1 GROUP BY "incremental_model"."month"), "get_previous_months_data" AS (SELECT "incremental_model"."user_id" AS "user_id", LAG("incremental_model"."month") OVER (PARTITION BY "incremental_model"."user_id" ORDER BY "incremental_model"."month" ASC) AS "previous_month", LAG("incremental_model"."customer_flag") OVER (PARTITION BY "incremental_model"."user_id" ORDER BY "incremental_model"."month" ASC) AS "previous_customer_flag", "incremental_model"."month" AS "current_month", "incremental_model"."customer_flag" AS "current_customer_flag" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__4290955__temp" AS "incremental_model"), "customer_churn_count" AS (SELECT COUNT(DISTINCT "get_previous_months_data"."user_id") AS "overall_churn", "get_previous_months_data"."current_month" AS "current_month" FROM "get_previous_months_data" AS "get_previous_months_data" WHERE "get_previous_months_data"."current_customer_flag" = 0 AND "get_previous_months_data"."previous_customer_flag" = 1 AND DATE_DIFF('MONTH', "get_previous_months_data"."current_month", "get_previous_months_data"."previous_month") = 1 GROUP BY "get_previous_months_data"."current_month"), "customer_return_count" AS (SELECT COUNT(DISTINCT "get_previous_months_data"."user_id") AS "overall_return", "get_previous_months_data"."current_month" AS "current_month" FROM "get_previous_months_data" AS "get_previous_months_data" WHERE "get_previous_months_data"."current_customer_flag" = 1 AND "get_previous_months_data"."previous_customer_flag" = 0 AND DATE_DIFF('MONTH', "get_previous_months_data"."current_month", "get_previous_months_data"."previous_month") = 1 GROUP BY "get_previous_months_data"."current_month") SELECT "sm"."cohort_month" AS "cohort_month", "sm"."month" AS "month", DATE_DIFF('MONTH', '2024-05-01', '2024-06-01') + 1 AS "relative_month_number", "total"."customer_count" AS "overall_customers", "churn"."overall_churn" AS "overall_churn", "return"."overall_return" AS "overall_return" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__4290955__temp" AS "sm" JOIN "total_customers_by_month" AS "total" ON "sm"."month" = "total"."month" JOIN "customer_churn_count" AS "churn" ON "churn"."current_month" = "sm"."month" JOIN "customer_return_count" AS "return" ON "return"."current_month" = "sm"."month" (base.py:1834)
2024-05-28 19:15:52,556 - MainThread - sqlmesh.core.context - ERROR - Apply Failure: Traceback (most recent call last):
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/utils/concurrency.py", line 227, in sequential_apply_to_dag
    fn(node)
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/utils/concurrency.py", line 165, in <lambda>
    lambda s_id: fn(snapshots_by_id[s_id]),
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/core/snapshot/evaluator.py", line 293, in <lambda>
    lambda s: self._create_snapshot(
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/core/snapshot/evaluator.py", line 680, in _create_snapshot
    evaluation_strategy.create(
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/core/snapshot/evaluator.py", line 1588, in create
    self.adapter.create_view(
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/core/engine_adapter/shared.py", line 260, in internal_wrapper
    return func(*list_args, **kwargs)
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/core/engine_adapter/base.py", line 889, in create_view
    self.execute(
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/core/engine_adapter/base.py", line 1831, in execute
    self._execute(sql, **kwargs)
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/core/engine_adapter/base.py", line 1837, in _execute
    self.cursor.execute(sql, **kwargs)
duckdb.duckdb.BinderException: Binder Error: Could not choose a best candidate function for the function call "date_diff(STRING_LITERAL, STRING_LITERAL, STRING_LITERAL)". In order to select one, please add explicit type casts.
	Candidate functions:
	date_diff(VARCHAR, TIMESTAMP, TIMESTAMP) -> BIGINT
	date_diff(VARCHAR, TIME, TIME) -> BIGINT
	date_diff(VARCHAR, TIMESTAMP WITH TIME ZONE, TIMESTAMP WITH TIME ZONE) -> BIGINT
	date_diff(VARCHAR, DATE, DATE) -> BIGINT

LINE 1: ...ohort_month", "sm"."month" AS "month", DATE_DIFF('MONTH', '2024-05-01', '2024-...
                                                  ^

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/core/context.py", line 1172, in apply
    self._apply(plan, circuit_breaker)
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/core/context.py", line 1715, in _apply
    self._scheduler.create_plan_evaluator(self).evaluate(plan, circuit_breaker=circuit_breaker)
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/core/plan/evaluator.py", line 109, in evaluate
    self._push(plan, deployability_index_for_creation)
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/core/plan/evaluator.py", line 199, in _push
    self.snapshot_evaluator.create(
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/core/snapshot/evaluator.py", line 291, in create
    concurrent_apply_to_snapshots(
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/utils/concurrency.py", line 163, in concurrent_apply_to_snapshots
    return concurrent_apply_to_dag(
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/utils/concurrency.py", line 198, in concurrent_apply_to_dag
    return sequential_apply_to_dag(dag, fn, raise_on_error)
  File "/Users/alexanderstoner/dev/sqlmesh-prac/.env/lib/python3.9/site-packages/sqlmesh/utils/concurrency.py", line 230, in sequential_apply_to_dag
    raise NodeExecutionFailedError(node) from ex
sqlmesh.utils.concurrency.NodeExecutionFailedError: Execution failed for node SnapshotId<"db"."splice_case_study"."view_model": 215869657>
 (context.py:1180)
2024-05-28 19:15:52,560 - MainThread - root - INFO - Shutting down the event dispatcher (dispatcher.py:159)
