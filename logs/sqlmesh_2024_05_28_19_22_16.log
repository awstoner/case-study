2024-05-28 19:22:16,142 - MainThread - sqlmesh.core.config.connection - INFO - Creating new DuckDB adapter for data files: {'db.db'} (connection.py:294)
2024-05-28 19:22:16,475 - MainThread - sqlmesh.core.config.connection - INFO - Using existing DuckDB adapter due to overlapping data file: db.db (connection.py:290)
2024-05-28 19:22:20,410 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Listing data objects in schema db.sqlmesh__splice_case_study (evaluator.py:266)
2024-05-28 19:22:20,410 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: SELECT CURRENT_CATALOG() (base.py:1834)
2024-05-28 19:22:20,413 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: SELECT CURRENT_CATALOG() (base.py:1834)
2024-05-28 19:22:20,414 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: SELECT table_name AS name, table_schema AS schema, CASE table_type WHEN 'BASE TABLE' THEN 'table' WHEN 'VIEW' THEN 'view' WHEN 'LOCAL TEMPORARY' THEN 'table' END AS type FROM information_schema.tables WHERE table_schema = 'sqlmesh__splice_case_study' AND table_name IN ('splice_case_study__incremental_model__978243220', 'splice_case_study__seed_model__84995534__temp', 'splice_case_study__view_model__2657901640', 'splice_case_study__seed_model__84995534', 'splice_case_study__view_model__2657901640__temp', 'splice_case_study__incremental_model__978243220__temp') (base.py:1834)
2024-05-28 19:22:20,442 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Creating schema 'db.sqlmesh__splice_case_study' (evaluator.py:850)
2024-05-28 19:22:20,443 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE SCHEMA IF NOT EXISTS "db"."sqlmesh__splice_case_study" (base.py:1834)
2024-05-28 19:22:20,444 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Creating view 'db.sqlmesh__splice_case_study.splice_case_study__view_model__2657901640__temp' (evaluator.py:1587)
2024-05-28 19:22:20,471 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE OR REPLACE VIEW "db"."sqlmesh__splice_case_study"."splice_case_study__view_model__2657901640__temp" AS WITH "total_customers_by_month" AS (SELECT COUNT(DISTINCT "incremental_model"."user_id") AS "customer_count", "incremental_model"."month" AS "month" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220__temp" AS "incremental_model" WHERE "incremental_model"."customer_flag" = 1 GROUP BY "incremental_model"."month"), "get_previous_months_data" AS (SELECT "incremental_model"."user_id" AS "user_id", LAG("incremental_model"."month") OVER (PARTITION BY "incremental_model"."user_id" ORDER BY "incremental_model"."month" ASC) AS "previous_month", LAG("incremental_model"."customer_flag") OVER (PARTITION BY "incremental_model"."user_id" ORDER BY "incremental_model"."month" ASC) AS "previous_customer_flag", "incremental_model"."month" AS "current_month", "incremental_model"."customer_flag" AS "current_customer_flag" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220__temp" AS "incremental_model"), "customer_churn_count" AS (SELECT COUNT(DISTINCT "get_previous_months_data"."user_id") AS "overall_churn", "get_previous_months_data"."current_month" AS "current_month" FROM "get_previous_months_data" AS "get_previous_months_data" WHERE "get_previous_months_data"."current_customer_flag" = 0 AND "get_previous_months_data"."previous_customer_flag" = 1 AND DATE_DIFF('MONTH', "get_previous_months_data"."current_month", "get_previous_months_data"."previous_month") = 1 GROUP BY "get_previous_months_data"."current_month"), "customer_return_count" AS (SELECT COUNT(DISTINCT "get_previous_months_data"."user_id") AS "overall_return", "get_previous_months_data"."current_month" AS "current_month" FROM "get_previous_months_data" AS "get_previous_months_data" WHERE "get_previous_months_data"."current_customer_flag" = 1 AND "get_previous_months_data"."previous_customer_flag" = 0 AND DATE_DIFF('MONTH', "get_previous_months_data"."current_month", "get_previous_months_data"."previous_month") = 1 GROUP BY "get_previous_months_data"."current_month") SELECT "sm"."cohort_month" AS "cohort_month", "sm"."month" AS "month", DATE_DIFF('MONTH', "sm"."cohort_month", "sm"."month") + 1 AS "relative_month_number", "total"."customer_count" AS "overall_customers", "churn"."overall_churn" AS "overall_churn", "return"."overall_return" AS "overall_return" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220__temp" AS "sm" JOIN "total_customers_by_month" AS "total" ON "sm"."month" = "total"."month" JOIN "customer_churn_count" AS "churn" ON "churn"."current_month" = "sm"."month" JOIN "customer_return_count" AS "return" ON "return"."current_month" = "sm"."month" (base.py:1834)
2024-05-28 19:22:20,473 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Creating view 'db.sqlmesh__splice_case_study.splice_case_study__view_model__2657901640' (evaluator.py:1587)
2024-05-28 19:22:20,495 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE OR REPLACE VIEW "db"."sqlmesh__splice_case_study"."splice_case_study__view_model__2657901640" AS WITH "total_customers_by_month" AS (SELECT COUNT(DISTINCT "incremental_model"."user_id") AS "customer_count", "incremental_model"."month" AS "month" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220__temp" AS "incremental_model" WHERE "incremental_model"."customer_flag" = 1 GROUP BY "incremental_model"."month"), "get_previous_months_data" AS (SELECT "incremental_model"."user_id" AS "user_id", LAG("incremental_model"."month") OVER (PARTITION BY "incremental_model"."user_id" ORDER BY "incremental_model"."month" ASC) AS "previous_month", LAG("incremental_model"."customer_flag") OVER (PARTITION BY "incremental_model"."user_id" ORDER BY "incremental_model"."month" ASC) AS "previous_customer_flag", "incremental_model"."month" AS "current_month", "incremental_model"."customer_flag" AS "current_customer_flag" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220__temp" AS "incremental_model"), "customer_churn_count" AS (SELECT COUNT(DISTINCT "get_previous_months_data"."user_id") AS "overall_churn", "get_previous_months_data"."current_month" AS "current_month" FROM "get_previous_months_data" AS "get_previous_months_data" WHERE "get_previous_months_data"."current_customer_flag" = 0 AND "get_previous_months_data"."previous_customer_flag" = 1 AND DATE_DIFF('MONTH', "get_previous_months_data"."current_month", "get_previous_months_data"."previous_month") = 1 GROUP BY "get_previous_months_data"."current_month"), "customer_return_count" AS (SELECT COUNT(DISTINCT "get_previous_months_data"."user_id") AS "overall_return", "get_previous_months_data"."current_month" AS "current_month" FROM "get_previous_months_data" AS "get_previous_months_data" WHERE "get_previous_months_data"."current_customer_flag" = 1 AND "get_previous_months_data"."previous_customer_flag" = 0 AND DATE_DIFF('MONTH', "get_previous_months_data"."current_month", "get_previous_months_data"."previous_month") = 1 GROUP BY "get_previous_months_data"."current_month") SELECT "sm"."cohort_month" AS "cohort_month", "sm"."month" AS "month", DATE_DIFF('MONTH', "sm"."cohort_month", "sm"."month") + 1 AS "relative_month_number", "total"."customer_count" AS "overall_customers", "churn"."overall_churn" AS "overall_churn", "return"."overall_return" AS "overall_return" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220__temp" AS "sm" JOIN "total_customers_by_month" AS "total" ON "sm"."month" = "total"."month" JOIN "customer_churn_count" AS "churn" ON "churn"."current_month" = "sm"."month" JOIN "customer_return_count" AS "return" ON "return"."current_month" = "sm"."month" (base.py:1834)
2024-05-28 19:22:20,514 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Evaluating snapshot SnapshotId<"db"."splice_case_study"."incremental_model": 3958379838> (evaluator.py:480)
2024-05-28 19:22:20,519 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Inserting batch (2023-06-01 00:00:00+00:00, 2024-05-29 00:00:00+00:00) into db.sqlmesh__splice_case_study.splice_case_study__incremental_model__978243220__temp' (evaluator.py:505)
2024-05-28 19:22:20,520 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: DELETE FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220__temp" WHERE "month" BETWEEN CAST('2023-06-01' AS DATE) AND CAST('2024-05-28' AS DATE) (base.py:1834)
2024-05-28 19:22:20,522 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: INSERT INTO "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220__temp" ("month", "user_id", "cohort_month", "customer_flag") SELECT "month", "user_id", "cohort_month", "customer_flag" FROM (SELECT CAST("seed_model"."month" AS DATE) AS "month", CAST("seed_model"."user_id" AS BIGINT) AS "user_id", CAST("seed_model"."cohort_month" AS DATE) AS "cohort_month", CAST("seed_model"."customer_flag" AS INT) AS "customer_flag" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__seed_model__84995534__temp" AS "seed_model" WHERE "seed_model"."month" <= CAST('2024-05-28' AS DATE) AND "seed_model"."month" >= CAST('2023-06-01' AS DATE)) AS "_subquery" WHERE "month" BETWEEN CAST('2023-06-01' AS DATE) AND CAST('2024-05-28' AS DATE) (base.py:1834)
2024-05-28 19:22:20,522 - MainThread - sqlmesh.core.state_sync.engine_adapter - INFO - Adding dev interval (1685577600000, 1716940800000) for snapshot SnapshotId<"db"."splice_case_study"."incremental_model": 3958379838> (engine_adapter.py:600)
2024-05-28 19:22:20,528 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Evaluating snapshot SnapshotId<"db"."splice_case_study"."view_model": 2683532409> (evaluator.py:480)
2024-05-28 19:22:20,548 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Inserting batch (2023-06-01 00:00:00+00:00, 2024-05-29 00:00:00+00:00) into db.sqlmesh__splice_case_study.splice_case_study__view_model__2657901640__temp' (evaluator.py:505)
2024-05-28 19:22:20,548 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Replacing view 'db.sqlmesh__splice_case_study.splice_case_study__view_model__2657901640__temp' (evaluator.py:1554)
2024-05-28 19:22:20,550 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE OR REPLACE VIEW "db"."sqlmesh__splice_case_study"."splice_case_study__view_model__2657901640__temp" ("cohort_month", "month", "relative_month_number", "overall_customers", "overall_churn", "overall_return") AS WITH "total_customers_by_month" AS (SELECT COUNT(DISTINCT "incremental_model"."user_id") AS "customer_count", "incremental_model"."month" AS "month" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220__temp" AS "incremental_model" WHERE "incremental_model"."customer_flag" = 1 GROUP BY "incremental_model"."month"), "get_previous_months_data" AS (SELECT "incremental_model"."user_id" AS "user_id", LAG("incremental_model"."month") OVER (PARTITION BY "incremental_model"."user_id" ORDER BY "incremental_model"."month" ASC) AS "previous_month", LAG("incremental_model"."customer_flag") OVER (PARTITION BY "incremental_model"."user_id" ORDER BY "incremental_model"."month" ASC) AS "previous_customer_flag", "incremental_model"."month" AS "current_month", "incremental_model"."customer_flag" AS "current_customer_flag" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220__temp" AS "incremental_model"), "customer_churn_count" AS (SELECT COUNT(DISTINCT "get_previous_months_data"."user_id") AS "overall_churn", "get_previous_months_data"."current_month" AS "current_month" FROM "get_previous_months_data" AS "get_previous_months_data" WHERE "get_previous_months_data"."current_customer_flag" = 0 AND "get_previous_months_data"."previous_customer_flag" = 1 AND DATE_DIFF('MONTH', "get_previous_months_data"."current_month", "get_previous_months_data"."previous_month") = 1 GROUP BY "get_previous_months_data"."current_month"), "customer_return_count" AS (SELECT COUNT(DISTINCT "get_previous_months_data"."user_id") AS "overall_return", "get_previous_months_data"."current_month" AS "current_month" FROM "get_previous_months_data" AS "get_previous_months_data" WHERE "get_previous_months_data"."current_customer_flag" = 1 AND "get_previous_months_data"."previous_customer_flag" = 0 AND DATE_DIFF('MONTH', "get_previous_months_data"."current_month", "get_previous_months_data"."previous_month") = 1 GROUP BY "get_previous_months_data"."current_month") SELECT "sm"."cohort_month" AS "cohort_month", "sm"."month" AS "month", DATE_DIFF('MONTH', "sm"."cohort_month", "sm"."month") + 1 AS "relative_month_number", "total"."customer_count" AS "overall_customers", "churn"."overall_churn" AS "overall_churn", "return"."overall_return" AS "overall_return" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220__temp" AS "sm" JOIN "total_customers_by_month" AS "total" ON "sm"."month" = "total"."month" JOIN "customer_churn_count" AS "churn" ON "churn"."current_month" = "sm"."month" JOIN "customer_return_count" AS "return" ON "return"."current_month" = "sm"."month" (base.py:1834)
2024-05-28 19:22:20,551 - MainThread - sqlmesh.core.state_sync.engine_adapter - INFO - Adding dev interval (1685577600000, 1716940800000) for snapshot SnapshotId<"db"."splice_case_study"."view_model": 2683532409> (engine_adapter.py:600)
2024-05-28 19:22:20,558 - MainThread - sqlmesh.core.state_sync.common - INFO - Promoting environment 'dev' (common.py:119)
2024-05-28 19:22:20,572 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Creating schema 'db.splice_case_study__dev' (evaluator.py:850)
2024-05-28 19:22:20,572 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE SCHEMA IF NOT EXISTS "db"."splice_case_study__dev" (base.py:1834)
2024-05-28 19:22:20,572 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Updating view 'db.splice_case_study__dev.incremental_model' to point at table 'db.sqlmesh__splice_case_study.splice_case_study__incremental_model__978243220__temp' (evaluator.py:1116)
2024-05-28 19:22:20,573 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE OR REPLACE VIEW "db"."splice_case_study__dev"."incremental_model" AS SELECT * FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220__temp" (base.py:1834)
2024-05-28 19:22:20,574 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Updating view 'db.splice_case_study__dev.view_model' to point at table 'db.sqlmesh__splice_case_study.splice_case_study__view_model__2657901640__temp' (evaluator.py:1116)
2024-05-28 19:22:20,574 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE OR REPLACE VIEW "db"."splice_case_study__dev"."view_model" AS SELECT * FROM "db"."sqlmesh__splice_case_study"."splice_case_study__view_model__2657901640__temp" (base.py:1834)
2024-05-28 19:22:20,575 - MainThread - sqlmesh.core.state_sync.common - INFO - Finalizing environment 'dev' (common.py:197)
2024-05-28 19:22:20,593 - MainThread - root - INFO - Shutting down the event dispatcher (dispatcher.py:159)
