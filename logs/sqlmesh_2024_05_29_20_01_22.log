2024-05-29 20:01:22,109 - MainThread - sqlmesh.core.config.connection - INFO - Creating new DuckDB adapter for data files: {'db.db'} (connection.py:294)
2024-05-29 20:01:22,420 - MainThread - sqlmesh.core.config.connection - INFO - Using existing DuckDB adapter due to overlapping data file: db.db (connection.py:290)
2024-05-29 20:01:32,494 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Listing data objects in schema db.sqlmesh__splice_case_study (evaluator.py:266)
2024-05-29 20:01:32,494 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: SELECT CURRENT_CATALOG() (base.py:1834)
2024-05-29 20:01:32,496 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: SELECT CURRENT_CATALOG() (base.py:1834)
2024-05-29 20:01:32,497 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: SELECT table_name AS name, table_schema AS schema, CASE table_type WHEN 'BASE TABLE' THEN 'table' WHEN 'VIEW' THEN 'view' WHEN 'LOCAL TEMPORARY' THEN 'table' END AS type FROM information_schema.tables WHERE table_schema = 'sqlmesh__splice_case_study' AND table_name IN ('splice_case_study__full_model__2577705809__temp', 'splice_case_study__incremental_model__978243220', 'splice_case_study__seed_model__84995534', 'splice_case_study__incremental_model__978243220__temp', 'splice_case_study__full_model__2577705809', 'splice_case_study__seed_model__84995534__temp') (base.py:1834)
2024-05-29 20:01:32,533 - MainThread - sqlmesh.core.state_sync.common - INFO - Promoting environment 'prod' (common.py:119)
2024-05-29 20:01:32,544 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Altering table 'db.sqlmesh__splice_case_study.splice_case_study__seed_model__84995534' (evaluator.py:1204)
2024-05-29 20:01:32,544 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: DESCRIBE "db"."sqlmesh__splice_case_study"."splice_case_study__seed_model__84995534" (base.py:1834)
2024-05-29 20:01:32,544 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: DESCRIBE "db"."sqlmesh__splice_case_study"."splice_case_study__seed_model__84995534__temp" (base.py:1834)
2024-05-29 20:01:32,556 - MainThread - sqlmesh.core.state_sync.common - INFO - Unpausing snapshot SnapshotId<"db"."splice_case_study"."full_model": 669160620> (common.py:224)
2024-05-29 20:01:32,559 - MainThread - sqlmesh.core.state_sync.common - INFO - Unpausing snapshot SnapshotId<"db"."splice_case_study"."incremental_model": 3958379838> (common.py:224)
2024-05-29 20:01:32,561 - MainThread - sqlmesh.core.state_sync.common - INFO - Marking snapshot SnapshotId<"db"."splice_case_study"."seed_model": 3757775351> as unrestorable (common.py:254)
2024-05-29 20:01:32,563 - MainThread - sqlmesh.core.state_sync.common - INFO - Unpausing snapshot SnapshotId<"db"."splice_case_study"."seed_model": 1168379772> (common.py:224)
2024-05-29 20:01:32,571 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Evaluating snapshot SnapshotId<"db"."splice_case_study"."incremental_model": 3958379838> (evaluator.py:480)
2024-05-29 20:01:32,578 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Inserting batch (2023-06-01 00:00:00+00:00, 2024-05-30 00:00:00+00:00) into db.sqlmesh__splice_case_study.splice_case_study__incremental_model__978243220' (evaluator.py:505)
2024-05-29 20:01:32,578 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: DELETE FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220" WHERE "month" BETWEEN CAST('2023-06-01' AS DATE) AND CAST('2024-05-29' AS DATE) (base.py:1834)
2024-05-29 20:01:32,581 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: INSERT INTO "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220" ("month", "user_id", "cohort_month", "customer_flag") SELECT "month", "user_id", "cohort_month", "customer_flag" FROM (SELECT CAST("seed_model"."month" AS DATE) AS "month", CAST("seed_model"."user_id" AS BIGINT) AS "user_id", CAST("seed_model"."cohort_month" AS DATE) AS "cohort_month", CAST("seed_model"."customer_flag" AS INT) AS "customer_flag" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__seed_model__84995534" AS "seed_model" WHERE "seed_model"."month" <= CAST('2024-05-29' AS DATE) AND "seed_model"."month" >= CAST('2023-06-01' AS DATE)) AS "_subquery" WHERE "month" BETWEEN CAST('2023-06-01' AS DATE) AND CAST('2024-05-29' AS DATE) (base.py:1834)
2024-05-29 20:01:32,603 - MainThread - sqlmesh.core.state_sync.engine_adapter - INFO - Adding interval (1685577600000, 1717027200000) for snapshot SnapshotId<"db"."splice_case_study"."incremental_model": 3958379838> (engine_adapter.py:600)
2024-05-29 20:01:32,612 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Evaluating snapshot SnapshotId<"db"."splice_case_study"."full_model": 669160620> (evaluator.py:480)
2024-05-29 20:01:32,625 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Inserting batch (2023-06-01 00:00:00+00:00, 2024-05-30 00:00:00+00:00) into db.sqlmesh__splice_case_study.splice_case_study__full_model__2577705809' (evaluator.py:505)
2024-05-29 20:01:32,626 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE OR REPLACE TABLE "db"."sqlmesh__splice_case_study"."splice_case_study__full_model__2577705809" AS WITH "churn_return_calc" AS (SELECT "incremental_model"."cohort_month" AS "cohort_month", "incremental_model"."month" AS "month", DATE_DIFF('MONTH', "incremental_model"."cohort_month", "incremental_model"."month") + 1 AS "relative_month_number", "incremental_model"."user_id" AS "user_id", "incremental_model"."customer_flag" AS "customer_flag", CASE WHEN "incremental_model"."customer_flag" = 0 AND LAG("incremental_model"."customer_flag", 1) OVER (PARTITION BY "incremental_model"."user_id" ORDER BY "incremental_model"."month") = 1 THEN 1 WHEN "incremental_model"."customer_flag" = 1 AND LAG("incremental_model"."customer_flag", 1) OVER (PARTITION BY "incremental_model"."user_id" ORDER BY "incremental_model"."month") = 0 THEN 2 ELSE NULL END AS "return_or_churn_flag" FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220" AS "incremental_model" WHERE DATE_DIFF('MONTH', "incremental_model"."cohort_month", "incremental_model"."month") >= 0) SELECT "churn_return_calc"."cohort_month" AS "cohort_month", "churn_return_calc"."month" AS "month", "churn_return_calc"."relative_month_number" AS "relative_month_number", COUNT(DISTINCT CASE WHEN "churn_return_calc"."customer_flag" = 1 THEN "churn_return_calc"."user_id" END) AS "overall_customers", COUNT(DISTINCT CASE WHEN "churn_return_calc"."return_or_churn_flag" = 1 THEN "churn_return_calc"."user_id" END) AS "overall_churn", COUNT(DISTINCT CASE WHEN "churn_return_calc"."return_or_churn_flag" = 2 THEN "churn_return_calc"."user_id" END) AS "overall_return" FROM "churn_return_calc" AS "churn_return_calc" GROUP BY "churn_return_calc"."cohort_month", "churn_return_calc"."month", "churn_return_calc"."relative_month_number" ORDER BY "cohort_month", "month", "relative_month_number" (base.py:1834)
2024-05-29 20:01:32,667 - MainThread - sqlmesh.core.state_sync.engine_adapter - INFO - Adding interval (1685577600000, 1717027200000) for snapshot SnapshotId<"db"."splice_case_study"."full_model": 669160620> (engine_adapter.py:600)
2024-05-29 20:01:32,675 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Creating schema 'db.splice_case_study' (evaluator.py:850)
2024-05-29 20:01:32,675 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE SCHEMA IF NOT EXISTS "db"."splice_case_study" (base.py:1834)
2024-05-29 20:01:32,676 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Updating view 'db.splice_case_study.seed_model' to point at table 'db.sqlmesh__splice_case_study.splice_case_study__seed_model__84995534' (evaluator.py:1116)
2024-05-29 20:01:32,676 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE OR REPLACE VIEW "db"."splice_case_study"."seed_model" AS SELECT * FROM "db"."sqlmesh__splice_case_study"."splice_case_study__seed_model__84995534" (base.py:1834)
2024-05-29 20:01:32,676 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: COMMENT ON VIEW "db"."splice_case_study"."seed_model" IS 'Customer account IDs and subscription status stored monthly.' (base.py:1834)
2024-05-29 20:01:32,678 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Updating view 'db.splice_case_study.incremental_model' to point at table 'db.sqlmesh__splice_case_study.splice_case_study__incremental_model__978243220' (evaluator.py:1116)
2024-05-29 20:01:32,678 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE OR REPLACE VIEW "db"."splice_case_study"."incremental_model" AS SELECT * FROM "db"."sqlmesh__splice_case_study"."splice_case_study__incremental_model__978243220" (base.py:1834)
2024-05-29 20:01:32,679 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Updating view 'db.splice_case_study.full_model' to point at table 'db.sqlmesh__splice_case_study.splice_case_study__full_model__2577705809' (evaluator.py:1116)
2024-05-29 20:01:32,679 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE OR REPLACE VIEW "db"."splice_case_study"."full_model" AS SELECT * FROM "db"."sqlmesh__splice_case_study"."splice_case_study__full_model__2577705809" (base.py:1834)
2024-05-29 20:01:32,680 - MainThread - sqlmesh.core.state_sync.common - INFO - Finalizing environment 'prod' (common.py:197)
2024-05-29 20:01:32,707 - MainThread - root - INFO - Shutting down the event dispatcher (dispatcher.py:159)
